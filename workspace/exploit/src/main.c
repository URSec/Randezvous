/*
 * Copyright (c) 2022, University of Rochester
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include <stdint.h>
#include <stdio.h>
#include <string.h>

#include "board.h"

const char * __attribute__((noinline))
do_get_input(char * buf, size_t size)
{
	char * ptr = buf;

	printf("\r\nPlease type a string:\r\n");

	while (ptr < buf + size - 1) {
		char ch = getchar();
		if (ch == '\r' || ch == '\n') {
			break;
		}
		*ptr++ = ch;
	}

	*ptr++ = '\0';

	printf("\r\n");

	return buf;
}

const char * __attribute__((noinline))
do_print_output(const char * intro, size_t len, int hex, const char * buf)
{
	for (size_t i = 0; i < len; ++i) {
		if (hex) {
			printf("%.2x", intro[i]);
		} else {
			putchar(intro[i]);
		}
	}
	printf("\r\n%s\r\n", buf);

	return buf;
}

void
ditto(void)
{
	const char prompt[256] = "You typed: ";
	const char * volatile intro = NULL;
	volatile size_t len = 0;
	volatile int hex = 0;
	char * volatile ptr = NULL;
	char buf[16];

	while (1) {
		if (intro != prompt) {
			intro = prompt;
			len = strlen(intro);
		}
		hex = 0;
		if (ptr != buf) {
			ptr = buf;
		}

#ifdef VULNERABILITY
#define BUF_SIZE 4096
#else
#define BUF_SIZE sizeof(buf)
#endif
		do_get_input(ptr, BUF_SIZE);
		do_print_output(intro, len, hex, buf);
		do_get_input(ptr, BUF_SIZE);
		do_print_output(intro, len, hex, buf);
	}
}

int
main(void)
{
	setvbuf(stdin, NULL, _IONBF, 0);
	setvbuf(stdout, NULL, _IONBF, 0);

	extern void (* volatile func)(void);
	assert(func != NULL);

	ditto();

	return 0;
}
